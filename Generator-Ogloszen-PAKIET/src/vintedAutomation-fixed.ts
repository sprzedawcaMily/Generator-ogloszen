import puppeteer, { Browser, Page } from 'puppeteer';
import { fetchAdvertisements } from './supabaseFetcher';

interface Advertisement {
    id: number;
    title: string;
    description: string;
    price: number;
    photos: string[];
    is_completed: boolean;
    created_at: string;
}

class VintedAutomation {
    private browser: Browser | null = null;
    private page: Page | null = null;

    async init() {
        this.browser = await puppeteer.launch({
            headless: false, // Pokazuj przeglƒÖdarkƒô
            defaultViewport: null,
            args: [
                '--start-maximized',
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-dev-shm-usage',
                '--disable-accelerated-2d-canvas',
                '--no-first-run',
                '--no-zygote',
                '--disable-gpu',
                '--disable-web-security',
                '--disable-features=VizDisplayCompositor',
                // Wa≈ºne dla Google Auth
                '--disable-blink-features=AutomationControlled',
                '--disable-extensions-except',
                '--disable-extensions',
                '--no-default-browser-check',
                '--disable-default-apps',
                '--disable-component-extensions-with-background-pages',
                '--disable-ipc-flooding-protection'
            ]
        });
        
        this.page = await this.browser.newPage();
        
        // Ustaw User Agent jak w normalnej przeglƒÖdarce
        await this.page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
        
        // Usu≈Ñ w≈Ça≈õciwo≈õci, kt√≥re wskazujƒÖ na automatyzacjƒô
        await this.page.evaluateOnNewDocument(() => {
            // Ukryj webdriver property
            Object.defineProperty(navigator, 'webdriver', {
                get: () => undefined,
            });
            
            // Zmie≈Ñ w≈Ça≈õciwo≈õci kt√≥re wskazujƒÖ na headless
            Object.defineProperty(navigator, 'plugins', {
                get: () => [1, 2, 3, 4, 5],
            });
            
            Object.defineProperty(navigator, 'languages', {
                get: () => ['pl-PL', 'pl', 'en-US', 'en'],
            });
            
            // Dodaj chrome runtime
            (window as any).chrome = {
                runtime: {},
            };
            
            // Usu≈Ñ automation flag
            try {
                delete (navigator as any).__proto__.webdriver;
            } catch (e) {
                // Ignore if can't delete
            }
        });
        
        // Ustaw dodatkowe headers
        await this.page.setExtraHTTPHeaders({
            'Accept-Language': 'pl-PL,pl;q=0.9,en-US;q=0.8,en;q=0.7',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8',
            'Accept-Encoding': 'gzip, deflate, br',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1',
        });
        
        // Ustaw viewport na typowy rozmiar ekranu
        await this.page.setViewport({
            width: 1366,
            height: 768,
            deviceScaleFactor: 1,
        });
    }

    async openLoginPage() {
        if (!this.page) throw new Error('Page not initialized');
        
        console.log('üîê Pr√≥bujƒô otworzyƒá stronƒô logowania...');
        
        try {
            // Bezpo≈õrednia nawigacja na stronƒô logowania
            console.log('üîÑ Przechodzƒô na stronƒô logowania...');
            await this.page.goto('https://www.vinted.pl/member/sign_in', { waitUntil: 'networkidle2' });
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            console.log('üìÑ Strona logowania jest teraz otwarta');
            console.log('');
            console.log('üí° WA≈ªNE WSKAZ√ìWKI:');
            console.log('   ‚ùå NIE u≈ºywaj "Zaloguj siƒô przez Google"');
            console.log('   ‚úÖ U≈ºyj "Zaloguj siƒô przez email"');
            console.log('   ‚úÖ Lub utw√≥rz nowe konto bezpo≈õrednio');
            console.log('');
            
        } catch (error) {
            console.log('‚ö†Ô∏è  Nie uda≈Ço siƒô automatycznie otworzyƒá strony logowania');
            console.log('üîß Spr√≥buj rƒôcznie przej≈õƒá na stronƒô logowania');
        }
    }

    async checkIfLoggedIn(): Promise<boolean> {
        if (!this.page) return false;
        
        try {
            // Sprawd≈∫ czy istnieje element wskazujƒÖcy na zalogowanie
            const loggedInIndicators = [
                'button[data-testid="header-user-menu-button"]',
                '[data-testid="user-menu"]',
                '.user-avatar',
                'a[href*="/member"]',
                '[class*="user"]'
            ];
            
            for (const selector of loggedInIndicators) {
                try {
                    const element = await this.page.waitForSelector(selector, { timeout: 2000 });
                    if (element) {
                        console.log(`‚úÖ Znaleziono wska≈∫nik zalogowania: ${selector}`);
                        return true;
                    }
                } catch {
                    // Kontynuuj sprawdzanie innych selektor√≥w
                }
            }
            
            // Sprawd≈∫ przez JavaScript czy istnieje tekst wskazujƒÖcy na zalogowanie
            const hasUserProfile = await this.page.evaluate(() => {
                const texts = ['profil', 'konto', 'wyloguj', 'ustawienia'];
                const allText = document.body.textContent?.toLowerCase() || '';
                return texts.some(text => allText.includes(text));
            });
            
            if (hasUserProfile) {
                console.log('‚úÖ Znaleziono tekst wskazujƒÖcy na zalogowanie');
                return true;
            }
            
            // Sprawd≈∫ czy NIE ma przycisku "Zaloguj siƒô"
            const hasLoginButton = await this.page.evaluate(() => {
                const elements = Array.from(document.querySelectorAll('a, button'));
                return elements.some(el => {
                    const text = el.textContent?.toLowerCase() || '';
                    return text.includes('zaloguj') && text.includes('siƒô');
                });
            });
            
            return !hasLoginButton; // Je≈õli nie ma przycisku logowania, prawdopodobnie jeste≈õ zalogowany
            
        } catch (error) {
            console.log('B≈ÇƒÖd podczas sprawdzania stanu logowania:', error);
            return false;
        }
    }

    async navigateToVinted() {
        if (!this.page) throw new Error('Page not initialized');
        
        console.log('üìç Navigating to Vinted main page...');
        await this.page.goto('https://www.vinted.pl', {
            waitUntil: 'networkidle2'
        });
        
        // Czekaj na za≈Çadowanie strony
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        // Sprawd≈∫ czy jeste≈õ zalogowany
        const isLoggedIn = await this.checkIfLoggedIn();
        
        if (!isLoggedIn) {
            console.log('‚ö†Ô∏è  Nie jeste≈õ zalogowany na Vinted!');
            
            // Spr√≥buj otworzyƒá stronƒô logowania
            await this.openLoginPage();
            
            console.log('üìù Zaloguj siƒô rƒôcznie w przeglƒÖdarce...');
            console.log('‚è≥ Czekam 90 sekund na zalogowanie...');
            
            // Czekaj d≈Çu≈ºej na rƒôczne zalogowanie
            await new Promise(resolve => setTimeout(resolve, 90000));
            
            // Sprawd≈∫ ponownie
            const isLoggedInAfterWait = await this.checkIfLoggedIn();
            if (!isLoggedInAfterWait) {
                console.log('');
                console.log('‚ö†Ô∏è  Nadal nie wykryto logowania.');
                console.log('üí° Spr√≥buj:');
                console.log('   - Od≈õwie≈ºyƒá stronƒô');
                console.log('   - Zalogowaƒá siƒô przez email zamiast Google');
                console.log('   - Sprawdziƒá czy nie ma captcha');
                console.log('');
                console.log('‚è≥ Czekam jeszcze 30 sekund...');
                
                await new Promise(resolve => setTimeout(resolve, 30000));
                
                const finalCheck = await this.checkIfLoggedIn();
                if (!finalCheck) {
                    throw new Error('Nie uda≈Ço siƒô zalogowaƒá. Proszƒô zaloguj siƒô rƒôcznie i uruchom ponownie.');
                }
            }
        }
        
        console.log('‚úÖ Zalogowany pomy≈õlnie!');
    }

    async clickSellButton() {
        if (!this.page) throw new Error('Page not initialized');
        
        console.log('Looking for Sprzedaj button...');
        
        try {
            // Lista mo≈ºliwych selektor√≥w dla przycisku "Sprzedaj"
            const sellButtonSelectors = [
                'a[href="/items/new"]',
                'a[href*="/items/new"]',
                'button[href="/items/new"]',
                '[data-testid*="sell"]',
                '.sell-button'
            ];
            
            let buttonFound = false;
            
            // Pr√≥buj ka≈ºdy selektor
            for (const selector of sellButtonSelectors) {
                try {
                    console.log(`Trying selector: ${selector}`);
                    await this.page.waitForSelector(selector, { timeout: 3000 });
                    await this.page.click(selector);
                    console.log(`‚úÖ Clicked Sprzedaj button with selector: ${selector}`);
                    buttonFound = true;
                    break;
                } catch (error) {
                    console.log(`‚ùå Selector ${selector} not found, trying next...`);
                }
            }
            
            // Je≈õli ≈ºaden selektor nie zadzia≈Ça≈Ç, spr√≥buj znale≈∫ƒá przez tekst
            if (!buttonFound) {
                console.log('Trying to find button by text content...');
                buttonFound = await this.page.evaluate(() => {
                    // Znajd≈∫ wszystkie linki i przyciski
                    const elements = [
                        ...Array.from(document.querySelectorAll('a')),
                        ...Array.from(document.querySelectorAll('button'))
                    ];
                    
                    for (const element of elements) {
                        const text = element.textContent?.toLowerCase() || '';
                        const href = element.getAttribute('href') || '';
                        
                        if (text.includes('sprzedaj') || href.includes('/items/new')) {
                            (element as HTMLElement).click();
                            return true;
                        }
                    }
                    return false;
                });
                
                if (buttonFound) {
                    console.log('‚úÖ Found and clicked Sprzedaj button by text');
                }
            }
            
            if (!buttonFound) {
                // Wypisz dostƒôpne elementy na stronie dla debugowania
                console.log('üîç Available buttons and links on page:');
                const availableElements = await this.page.evaluate(() => {
                    const buttons = Array.from(document.querySelectorAll('button')).map(btn => ({
                        type: 'button',
                        text: btn.textContent?.trim(),
                        classes: btn.className
                    }));
                    
                    const links = Array.from(document.querySelectorAll('a')).map(link => ({
                        type: 'link',
                        text: link.textContent?.trim(),
                        href: link.getAttribute('href'),
                        classes: link.className
                    }));
                    
                    return [...buttons, ...links].slice(0, 20); // Poka≈º pierwsze 20 element√≥w
                });
                
                console.log(JSON.stringify(availableElements, null, 2));
                
                throw new Error('Nie znaleziono przycisku Sprzedaj. Sprawd≈∫ czy jeste≈õ zalogowany i na w≈Ça≈õciwej stronie.');
            }
            
            // Czekaj na za≈Çadowanie strony dodawania przedmiotu
            await this.page.waitForNavigation({ 
                waitUntil: 'networkidle2', 
                timeout: 15000 
            }).catch(() => {
                console.log('Navigation timeout - but continuing...');
            });
            
        } catch (error) {
            console.error('Error clicking Sprzedaj button:', error);
            throw error;
        }
    }

    async addPhotos(photoUrls: string[]) {
        if (!this.page) throw new Error('Page not initialized');
        
        console.log('Adding photos...');
        
        try {
            // Czekaj na za≈Çadowanie przycisk√≥w
            await this.page.waitForSelector('button', { timeout: 10000 });
            
            // Znajd≈∫ i kliknij przycisk "Dodaj zdjƒôcia"
            const buttonClicked = await this.page.evaluate(() => {
                const buttons = Array.from(document.querySelectorAll('button'));
                const addPhotosBtn = buttons.find(btn => btn.textContent?.includes('Dodaj zdjƒôcia'));
                if (addPhotosBtn) {
                    (addPhotosBtn as HTMLElement).click();
                    return true;
                }
                return false;
            });
            
            if (buttonClicked) {
                console.log('Clicked add photos button');
            } else {
                console.log('Add photos button not found');
            }
            
            // Tutaj dodasz logikƒô do uploadowania zdjƒôƒá
            // Na razie tylko logujemy URLs zdjƒôƒá
            console.log('Photos to upload:', photoUrls);
            
        } catch (error) {
            console.error('Error adding photos:', error);
        }
    }

    async fillTitle(title: string) {
        if (!this.page) throw new Error('Page not initialized');
        
        console.log('Filling title...');
        
        try {
            // Czekaj na pole tytu≈Çu
            await this.page.waitForSelector('input#title[data-testid="title--input"]', { timeout: 10000 });
            
            // Wyczy≈õƒá pole i wpisz tytu≈Ç
            await this.page.click('input#title[data-testid="title--input"]');
            await this.page.keyboard.down('Control');
            await this.page.keyboard.press('a');
            await this.page.keyboard.up('Control');
            await this.page.type('input#title[data-testid="title--input"]', title);
            
            console.log('Title filled:', title);
            
        } catch (error) {
            console.error('Error filling title:', error);
            throw error;
        }
    }

    async fillDescription(description: string) {
        if (!this.page) throw new Error('Page not initialized');
        
        console.log('Filling description...');
        
        try {
            // Czekaj na pole opisu
            await this.page.waitForSelector('textarea#description[data-testid="description--input"]', { timeout: 10000 });
            
            // Wyczy≈õƒá pole i wpisz opis
            await this.page.click('textarea#description[data-testid="description--input"]');
            await this.page.keyboard.down('Control');
            await this.page.keyboard.press('a');
            await this.page.keyboard.up('Control');
            await this.page.type('textarea#description[data-testid="description--input"]', description);
            
            console.log('Description filled');
            
        } catch (error) {
            console.error('Error filling description:', error);
            throw error;
        }
    }

    async processAdvertisement(ad: Advertisement) {
        console.log(`Processing advertisement: ${ad.title}`);
        
        try {
            // Dodaj zdjƒôcia
            if (ad.photos && ad.photos.length > 0) {
                await this.addPhotos(ad.photos);
            }
            
            // Poczekaj chwilƒô miƒôdzy akcjami
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Wype≈Çnij tytu≈Ç
            await this.fillTitle(ad.title);
            
            // Poczekaj chwilƒô miƒôdzy akcjami
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Wype≈Çnij opis
            await this.fillDescription(ad.description);
            
            console.log(`Advertisement processed: ${ad.title}`);
            
        } catch (error) {
            console.error(`Error processing advertisement ${ad.title}:`, error);
            throw error;
        }
    }

    async waitForUserInteraction(message: string, timeoutSeconds: number = 60) {
        if (!this.page) return;
        
        console.log(`\nüîÑ ${message}`);
        console.log(`‚è≥ Czekam ${timeoutSeconds} sekund na TwojƒÖ akcjƒô...`);
        console.log('üí° Mo≈ºesz kontynuowaƒá rƒôcznie w przeglƒÖdarce, a nastƒôpnie naci≈õnij Enter w terminalu');
        
        // Czekaj okre≈õlony czas
        await new Promise(resolve => setTimeout(resolve, timeoutSeconds * 1000));
    }

    async start() {
        try {
            console.log('üöÄ Starting Vinted automation...');
            
            // Inicjalizuj przeglƒÖdarkƒô
            await this.init();
            
            // Przejd≈∫ na Vinted
            await this.navigateToVinted();
            
            // Je≈õli nie uda≈Ço siƒô automatycznie sprawdziƒá logowania, daj u≈ºytkownikowi szansƒô
            await this.waitForUserInteraction('Upewnij siƒô, ≈ºe jeste≈õ zalogowany na Vinted', 10);
            
            // Kliknij przycisk "Sprzedaj"
            await this.clickSellButton();
            
            // Poczekaj na za≈Çadowanie formularza
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Pobierz og≈Çoszenia z bazy danych
            console.log('üì• Fetching advertisements from database...');
            const advertisements = await fetchAdvertisements();
            
            if (advertisements.length === 0) {
                console.log('‚ùå No advertisements found in database');
                return;
            }
            
            console.log(`‚úÖ Found ${advertisements.length} advertisements`);
            
            // Przetw√≥rz pierwsze og≈Çoszenie (mo≈ºesz rozszerzyƒá to o pƒôtlƒô)
            const firstAd = advertisements[0] as Advertisement;
            if (firstAd && !firstAd.is_completed) {
                await this.processAdvertisement(firstAd);
                
                // Czekaj na dalsze instrukcje od u≈ºytkownika
                console.log('‚úÖ Advertisement processing completed. Waiting for further instructions...');
                await this.waitForUserInteraction('Sprawd≈∫ formularz i kontynuuj rƒôcznie je≈õli potrzeba', 60);
            }
            
        } catch (error) {
            console.error('‚ùå Error in Vinted automation:', error);
            
            const errorMessage = error instanceof Error ? error.message : String(error);
            
            if (errorMessage.includes('TimeoutError') || errorMessage.includes('Waiting for selector')) {
                console.log('\nüí° RozwiƒÖzania problem√≥w:');
                console.log('1. Sprawd≈∫ czy jeste≈õ zalogowany na Vinted');
                console.log('2. Sprawd≈∫ czy strona siƒô w pe≈Çni za≈Çadowa≈Ça');
                console.log('3. Vinted mo≈ºe zmieniƒá interfejs - spr√≥buj rƒôcznie');
                console.log('4. Sprawd≈∫ po≈ÇƒÖczenie internetowe');
                
                // Nie zamykaj przeglƒÖdarki od razu, daj u≈ºytkownikowi szansƒô na rƒôcznƒÖ interakcjƒô
                await this.waitForUserInteraction('Mo≈ºesz kontynuowaƒá rƒôcznie w przeglƒÖdarce', 120);
            }
        }
    }

    async close() {
        if (this.browser) {
            await this.browser.close();
        }
    }
}

// Funkcja g≈Ç√≥wna do uruchomienia automatyzacji
export async function runVintedAutomation() {
    const automation = new VintedAutomation();
    
    try {
        await automation.start();
    } catch (error) {
        console.error('Vinted automation failed:', error);
    } finally {
        await automation.close();
    }
}

// Je≈õli plik jest uruchamiany bezpo≈õrednio
if (import.meta.main) {
    runVintedAutomation().catch(console.error);
}
